name: ForceTac Android Build (Hybrid Expo)

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configuration de Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK (Vital pour le C++)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Installation des d√©pendances
        run: |
          npm cache clean --force
          npm install --legacy-peer-deps
          # Installation de expo-cli localement pour le prebuild
          npm install -g expo-cli

      # Sauvegarde de votre code natif personnalis√© avant que le prebuild ne touche √† tout
      # On sauvegarde TOUT ce qui est critique
      - name: Backup Native Code
        run: |
          mkdir -p ../native_backup
          
          # Sauvegarde du C++
          if [ -d "android/app/src/main/cpp" ]; then 
            mkdir -p ../native_backup/cpp
            cp -r android/app/src/main/cpp/* ../native_backup/cpp/
          fi
          
          # Sauvegarde du Kotlin (ForceTac package)
          if [ -d "android/app/src/main/java/com/forcetac" ]; then 
            mkdir -p ../native_backup/forcetac
            cp -r android/app/src/main/java/com/forcetac/* ../native_backup/forcetac/
          fi
          
          # Sauvegarde des Assets (Cl√©s JSON)
          if [ -d "android/app/src/main/assets" ]; then 
            mkdir -p ../native_backup/assets
            cp -r android/app/src/main/assets/* ../native_backup/assets/
          fi
          
          # Sauvegarde de la config build.gradle (NDK config)
          if [ -f "android/app/build.gradle" ]; then cp android/app/build.gradle ../native_backup/; fi
          
          # Sauvegarde du Manifeste (Services HCE)
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then cp android/app/src/main/AndroidManifest.xml ../native_backup/; fi

      # G√©n√©ration de l'infrastructure Android via Expo
      # Cette √©tape cr√©e un dossier android/ propre et fonctionnel
      - name: Expo Prebuild
        run: npx expo prebuild --platform android --clean --no-interactive

      # Restauration et Injection du code ForceTac (C++ / Kotlin) dans le projet g√©n√©r√©
      - name: Inject ForceTac Native Engine
        run: |
          echo "üíâ Injecting C++ and Kotlin modules..."
          
          # 1. Restauration du moteur C++
          mkdir -p android/app/src/main/cpp
          cp -r ../native_backup/cpp/* android/app/src/main/cpp/
          
          # 2. Restauration du module Kotlin (NfcModule, HceService, Package)
          # On s'assure que le dossier package existe
          mkdir -p android/app/src/main/java/com/forcetac
          cp -r ../native_backup/forcetac/* android/app/src/main/java/com/forcetac/
          
          # 3. Restauration des Assets (Cl√©s, Ic√¥nes)
          mkdir -p android/app/src/main/assets
          if [ -d "../native_backup/assets" ]; then
             cp -r ../native_backup/assets/* android/app/src/main/assets/ || true
          fi
          
          # 4. Restauration du build.gradle (Vital pour le NDK)
          # On √©crase celui g√©n√©r√© par Expo car il ne contient pas la config externalNativeBuild
          cp ../native_backup/build.gradle android/app/
          
          # 5. Restauration du Manifeste (Pour les permissions NFC)
          cp ../native_backup/AndroidManifest.xml android/app/src/main/
          
          echo "‚úÖ Injection complete."

      # G√©n√©ration du Keystore
      - name: Generate Debug Keystore
        run: |
          cd android/app
          if [ -f debug.keystore ]; then rm debug.keystore; fi
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      # Correction du Wrapper Gradle (Force 8.6 pour compatibilit√© RN 0.74)
      - name: Fix Gradle Wrapper
        run: |
          cd android/gradle/wrapper
          sed -i 's/distributionUrl=.*$/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-8.6-bin.zip/g' gradle-wrapper.properties

      # Build final
      - name: Build Android APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-release
          path: android/app/build/outputs/apk/release/*.apk
