name: Build Android APK (Debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      # FIX 1 : Cr√©ation d'un package-lock.json bidon
      - name: Create Dummy Lockfile
        run: echo '{}' > package-lock.json

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: '' 

      - name: Configuration de Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Installation des d√©pendances
        run: |
          rm package-lock.json
          npm install --legacy-peer-deps --no-package-lock
          npm install expo@~50.0.14 react-native@0.73.6 expo-build-properties --legacy-peer-deps --save
          npm install -g expo-cli

      # VITAL : Sauvegarde du code natif (C++ / Kotlin) avant le nettoyage Expo
      # NOTE: On ne sauvegarde PLUS le AndroidManifest.xml car celui du repo est corrompu.
      # On va en g√©n√©rer un propre √† l'√©tape d'injection.
      - name: Backup Native Code
        run: |
          mkdir -p ../native_backup
          
          # Sauvegarde du C++
          if [ -d "android/app/src/main/cpp" ]; then 
            mkdir -p ../native_backup/cpp
            cp -r android/app/src/main/cpp/* ../native_backup/cpp/
          fi
          
          # Sauvegarde du Kotlin (ForceTac package)
          if [ -d "android/app/src/main/java/com/forcetac" ]; then 
            mkdir -p ../native_backup/forcetac
            cp -r android/app/src/main/java/com/forcetac/* ../native_backup/forcetac/
          fi
          
          # Sauvegarde des Assets (Cl√©s JSON)
          if [ -d "android/app/src/main/assets" ]; then 
            mkdir -p ../native_backup/assets
            cp -r android/app/src/main/assets/* ../native_backup/assets/
          fi
          
          # Sauvegarde de la config build.gradle (NDK config)
          if [ -f "android/app/build.gradle" ]; then cp android/app/build.gradle ../native_backup/; fi

      - name: Expo Prebuild
        run: npx expo prebuild --platform android --clean

      # VITAL : R√©injection du code natif ForceTac + FIX Manifeste
      - name: Inject ForceTac Native Engine
        run: |
          echo "üíâ Injecting C++ and Kotlin modules..."
          
          mkdir -p android/app/src/main/cpp
          cp -r ../native_backup/cpp/* android/app/src/main/cpp/
          
          mkdir -p android/app/src/main/java/com/forcetac
          cp -r ../native_backup/forcetac/* android/app/src/main/java/com/forcetac/
          
          mkdir -p android/app/src/main/assets
          if [ -d "../native_backup/assets" ]; then
             cp -r ../native_backup/assets/* android/app/src/main/assets/ || true
          fi
          
          # Restauration du build.gradle
          cp ../native_backup/build.gradle android/app/
          
          # FIX CRITIQUE: G√©n√©ration d'un AndroidManifest.xml PROPRE et VALIDE
          # (Celui du repo √©tait corrompu/dupliqu√©, causant l'erreur de parsing)
          cat <<EOF > android/app/src/main/AndroidManifest.xml
          <manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.forcetac">
              <uses-permission android:name="android.permission.NFC" />
              <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
              <uses-permission android:name="android.permission.VIBRATE" />
              <uses-permission android:name="android.permission.INTERNET" />
              <uses-feature android:name="android.hardware.nfc" android:required="true" />
              <uses-feature android:name="android.hardware.nfc.hce" android:required="true" />
              <application android:label="ForceTac" android:name=".MainApplication" android:icon="@mipmap/ic_launcher" android:allowBackup="false" android:theme="@style/AppTheme">
                  <activity android:name=".MainActivity" android:exported="true" android:configChanges="keyboard|keyboardHidden|orientation|screenSize|uiMode" android:launchMode="singleTask" android:windowSoftInputMode="adjustResize">
                      <intent-filter>
                          <action android:name="android.intent.action.MAIN" />
                          <category android:name="android.intent.category.LAUNCHER" />
                      </intent-filter>
                  </activity>
                  <service android:name=".HceService" android:exported="true" android:permission="android.permission.BIND_NFC_SERVICE">
                      <intent-filter>
                          <action android:name="android.nfc.cardemulation.action.HOST_APDU_SERVICE"/>
                      </intent-filter>
                      <meta-data android:name="android.nfc.cardemulation.host_apdu_service" android:resource="@xml/apdu_service"/>
                  </service>
              </application>
          </manifest>
          EOF
          
          # Cr√©ation du fichier apdu_service.xml manquant
          mkdir -p android/app/src/main/res/xml
          cat <<EOF > android/app/src/main/res/xml/apdu_service.xml
          <host-apdu-service xmlns:android="http://schemas.android.com/apk/res/android" android:description="@string/service_desc" android:requireDeviceUnlock="false">
              <aid-group android:description="@string/service_desc" android:category="other">
                  <aid-filter android:name="E01600000000" /> 
                  <aid-filter android:name="D2760000850101" />
              </aid-group>
          </host-apdu-service>
          EOF
          
          echo "‚úÖ Injection complete."

      - name: Force Bundle JS
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      - name: Fix Gradle Wrapper (Force 8.6-bin)
        run: |
          cd android/gradle/wrapper
          sed -i 's/distributionUrl=.*$/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-8.6-bin.zip/g' gradle-wrapper.properties

      - name: Build Android APK (Debug)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug -Dorg.gradle.jvmargs="-Xmx4608m -XX:MaxMetaspaceSize=1024m" --no-daemon --stacktrace

      - name: T√©l√©charger l'APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-v1-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
