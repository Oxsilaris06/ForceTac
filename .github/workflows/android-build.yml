name: ForceTac Android Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install Node Deps
        run: npm install

      - name: Generate Debug Keystore
        run: |
          mkdir -p android/app
          cd android/app
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          echo "âœ… Keystore generated at android/app/debug.keystore"

      - name: Setup Android Skeleton & Resources
        run: |
          echo "ðŸ”§ Generating temporary React Native project..."
          npx react-native@0.73.4 init TempProject --skip-install --version 0.73.4
          
          echo "ðŸ“¦ Copying critical infrastructure files..."
          cp -r TempProject/android/gradle android/
          cp TempProject/android/gradlew android/
          cp TempProject/android/gradlew.bat android/
          
          # Copie des fichiers de configuration si manquants
          if [ ! -f "android/build.gradle" ]; then
             cp TempProject/android/build.gradle android/
          fi
          if [ ! -f "android/settings.gradle" ]; then
             cp TempProject/android/settings.gradle android/
          fi
          if [ ! -f "android/gradle.properties" ]; then
             cp TempProject/android/gradle.properties android/
          fi

          # --- FIX CRITIQUE : GÃ©nÃ©ration des ressources manquantes ---
          
          # 1. CrÃ©ation des dossiers de ressources
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/xml

          # 2. GÃ©nÃ©ration de styles.xml (AppTheme)
          if [ ! -f "android/app/src/main/res/values/styles.xml" ]; then
            echo '<resources>
                <style name="AppTheme" parent="Theme.AppCompat.Light.NoActionBar">
                    <item name="android:textColor">#000000</item>
                </style>
            </resources>' > android/app/src/main/res/values/styles.xml
            echo "âœ… styles.xml created"
          fi

          # 3. GÃ©nÃ©ration de strings.xml (app_name & service_desc)
          # On Ã©crase pour Ãªtre sÃ»r d'avoir la bonne string
          echo '<resources>
              <string name="app_name">ForceTac</string>
              <string name="service_desc">ForceTac Service</string>
          </resources>' > android/app/src/main/res/values/strings.xml
          echo "âœ… strings.xml created/updated"

          # 4. GÃ©nÃ©ration de apdu_service.xml (NÃ©cessaire pour le HCE/Downgrade)
          # Correction: Utilisation de @string/service_desc au lieu d'une string brute
          echo '<host-apdu-service xmlns:android="http://schemas.android.com/apk/res/android"
              android:description="@string/service_desc"
              android:requireDeviceUnlock="false">
              <aid-group android:description="@string/service_desc" android:category="other">
                  <aid-filter android:name="F0010203040506"/>
              </aid-group>
          </host-apdu-service>' > android/app/src/main/res/xml/apdu_service.xml
          echo "âœ… apdu_service.xml created"

          # Nettoyage
          rm -rf TempProject
          chmod +x android/gradlew
          
          echo "âœ… Android skeleton and resources fully restored."

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-release
          path: android/app/build/outputs/apk/release/*.apk
