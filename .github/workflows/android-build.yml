name: ForceTac Android Build

# DÃ©clenchement manuel uniquement (bouton "Run workflow")
on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install Node Deps
        run: npm install

      - name: Setup Android Environment & Fix Resources
        run: |
          echo "ðŸ”§ Generating temporary React Native project for scaffolding..."
          npx react-native@0.73.4 init TempProject --skip-install --version 0.73.4
          
          echo "ðŸ“¦ Restoring infrastructure files..."
          
          # 1. Gradle Infrastructure
          cp -r TempProject/android/gradle android/
          cp TempProject/android/gradlew android/
          cp TempProject/android/gradlew.bat android/
          
          if [ ! -f "android/settings.gradle" ]; then cp TempProject/android/settings.gradle android/; fi
          if [ ! -f "android/gradle.properties" ]; then cp TempProject/android/gradle.properties android/; fi
          if [ ! -f "android/build.gradle" ]; then cp TempProject/android/build.gradle android/; fi
          
          # 2. Fix Missing Resources (Source of the build failure)
          echo "ðŸ©¹ Repairing missing XML resources..."
          mkdir -p android/app/src/main/res/values
          mkdir -p android/app/src/main/res/xml
          
          # Fix: error: resource style/AppTheme not found
          if [ ! -f "android/app/src/main/res/values/styles.xml" ]; then
            echo '<?xml version="1.0" encoding="utf-8"?>
            <resources>
                <style name="AppTheme" parent="Theme.AppCompat.Light.NoActionBar">
                    <item name="android:textColor">#000000</item>
                </style>
            </resources>' > android/app/src/main/res/values/styles.xml
          fi

          # Fix: error: resource xml/apdu_service not found
          # Note: We use a placeholder AID. Ensure this matches your real requirements if needed.
          echo '<?xml version="1.0" encoding="utf-8"?>
          <host-apdu-service xmlns:android="http://schemas.android.com/apk/res/android"
              android:description="@string/app_name"
              android:requireDeviceUnlock="false">
              <aid-group android:category="other" android:description="ForceTac">
                  <aid-filter android:name="F00102030405"/>
              </aid-group>
          </host-apdu-service>' > android/app/src/main/res/xml/apdu_service.xml
          
          # Fix: ensures @string/app_name exists for the manifest/apdu
          if [ ! -f "android/app/src/main/res/values/strings.xml" ]; then
             echo '<?xml version="1.0" encoding="utf-8"?>
             <resources>
                 <string name="app_name">ForceTac</string>
             </resources>' > android/app/src/main/res/values/strings.xml
          fi

          # 3. Cleanup
          rm -rf TempProject
          chmod +x android/gradlew
          
          echo "âœ… Android environment ready."

      - name: Build Release APK
        run: |
          cd android
          ./gradlew assembleRelease --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-release
          path: android/app/build/outputs/apk/release/*.apk
