name: Build Android APK (Debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      # FIX ULTIME : Cr√©ation d'un package-lock.json bidon pour satisfaire setup-node
      # L'action setup-node plante si elle ne trouve pas ce fichier quand le cache est activ√© implicitement.
      - name: Create Dummy Lockfile
        run: echo '{}' > package-lock.json

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # On laisse le cache d√©sactiv√© explicitement
          cache: '' 
          # Note: Si cache: '' √©choue encore, l'√©tape pr√©c√©dente aura cr√©√© le fichier requis pour √©viter l'erreur "not found".

      - name: Configuration de Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Installation des d√©pendances
        run: |
          # On supprime le fichier lock bidon pour laisser npm installer proprement
          rm package-lock.json
          npm install --legacy-peer-deps --no-package-lock
          npx expo install --fix

      # VITAL : Sauvegarde du code natif (C++ / Kotlin) avant le nettoyage Expo
      - name: Backup Native Code
        run: |
          mkdir -p ../native_backup
          
          # Sauvegarde du C++
          if [ -d "android/app/src/main/cpp" ]; then 
            mkdir -p ../native_backup/cpp
            cp -r android/app/src/main/cpp/* ../native_backup/cpp/
          fi
          
          # Sauvegarde du Kotlin (ForceTac package)
          if [ -d "android/app/src/main/java/com/forcetac" ]; then 
            mkdir -p ../native_backup/forcetac
            cp -r android/app/src/main/java/com/forcetac/* ../native_backup/forcetac/
          fi
          
          # Sauvegarde des Assets (Cl√©s JSON)
          if [ -d "android/app/src/main/assets" ]; then 
            mkdir -p ../native_backup/assets
            cp -r android/app/src/main/assets/* ../native_backup/assets/
          fi
          
          # Sauvegarde de la config build.gradle
          if [ -f "android/app/build.gradle" ]; then cp android/app/build.gradle ../native_backup/; fi
          
          # Sauvegarde du Manifeste
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then cp android/app/src/main/AndroidManifest.xml ../native_backup/; fi

      - name: Expo Prebuild
        run: npx expo prebuild --platform android --clean --no-interactive

      # VITAL : R√©injection du code natif
      - name: Inject ForceTac Native Engine
        run: |
          echo "üíâ Injecting C++ and Kotlin modules..."
          
          mkdir -p android/app/src/main/cpp
          cp -r ../native_backup/cpp/* android/app/src/main/cpp/
          
          mkdir -p android/app/src/main/java/com/forcetac
          cp -r ../native_backup/forcetac/* android/app/src/main/java/com/forcetac/
          
          mkdir -p android/app/src/main/assets
          if [ -d "../native_backup/assets" ]; then
             cp -r ../native_backup/assets/* android/app/src/main/assets/ || true
          fi
          
          cp ../native_backup/build.gradle android/app/
          cp ../native_backup/AndroidManifest.xml android/app/src/main/
          
          echo "‚úÖ Injection complete."

      - name: Force Bundle JS
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      - name: Fix Gradle Wrapper (Force 8.6-bin)
        run: |
          cd android/gradle/wrapper
          sed -i 's/distributionUrl=.*$/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-8.6-bin.zip/g' gradle-wrapper.properties

      - name: Build Android APK (Debug)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug -Dorg.gradle.jvmargs="-Xmx4608m -XX:MaxMetaspaceSize=1024m" --no-daemon --stacktrace

      - name: T√©l√©charger l'APK
        uses: actions/upload-artifact@v4
        with:
          name: comtac-v14-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
