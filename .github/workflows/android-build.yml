name: Build Android APK (Debug)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      # FIX 1 : CrÃ©ation d'un package-lock.json bidon pour satisfaire setup-node
      # ForceTac n'a pas de lockfile, donc on en crÃ©e un vide pour Ã©viter le crash de setup-node
      - name: Create Dummy Lockfile
        run: echo '{}' > package-lock.json

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: '' 

      - name: Configuration de Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Installation des dÃ©pendances
        run: |
          # Nettoyage du lockfile bidon
          rm package-lock.json
          
          # 1. Installation de base sans lockfile
          npm install --legacy-peer-deps --no-package-lock
          
          # 2. Installation explicite des versions compatibles Expo SDK 50
          # ForceTac utilise RN 0.73.4, on force une version expo compatible
          npm install expo@^50.0.0 react-native@0.73.6 --legacy-peer-deps --save
          
          # 3. Installation CLI Expo global
          npm install -g expo-cli

      # VITAL : Sauvegarde du code natif (C++ / Kotlin) avant le nettoyage Expo
      - name: Backup Native Code
        run: |
          mkdir -p ../native_backup
          
          # Sauvegarde du C++
          if [ -d "android/app/src/main/cpp" ]; then 
            mkdir -p ../native_backup/cpp
            cp -r android/app/src/main/cpp/* ../native_backup/cpp/
          fi
          
          # Sauvegarde du Kotlin (ForceTac package)
          if [ -d "android/app/src/main/java/com/forcetac" ]; then 
            mkdir -p ../native_backup/forcetac
            cp -r android/app/src/main/java/com/forcetac/* ../native_backup/forcetac/
          fi
          
          # Sauvegarde des Assets (ClÃ©s JSON)
          if [ -d "android/app/src/main/assets" ]; then 
            mkdir -p ../native_backup/assets
            cp -r android/app/src/main/assets/* ../native_backup/assets/
          fi
          
          # Sauvegarde de la config build.gradle (NDK config)
          if [ -f "android/app/build.gradle" ]; then cp android/app/build.gradle ../native_backup/; fi
          
          # Sauvegarde du Manifeste
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then cp android/app/src/main/AndroidManifest.xml ../native_backup/; fi

      # CORRECTION CRITIQUE : Flag --android-package "com.forcetac"
      # Cela force le nom du package et Ã©vite l'erreur "Input required"
      - name: Expo Prebuild
        run: npx expo prebuild --platform android --clean --android-package "com.forcetac"

      # VITAL : RÃ©injection du code natif ForceTac
      - name: Inject ForceTac Native Engine
        run: |
          echo "ðŸ’‰ Injecting C++ and Kotlin modules..."
          
          mkdir -p android/app/src/main/cpp
          cp -r ../native_backup/cpp/* android/app/src/main/cpp/
          
          mkdir -p android/app/src/main/java/com/forcetac
          cp -r ../native_backup/forcetac/* android/app/src/main/java/com/forcetac/
          
          mkdir -p android/app/src/main/assets
          if [ -d "../native_backup/assets" ]; then
             cp -r ../native_backup/assets/* android/app/src/main/assets/ || true
          fi
          
          # Restauration du build.gradle (contient la config externalNativeBuild pour Cmake)
          cp ../native_backup/build.gradle android/app/
          
          # Restauration du Manifeste
          cp ../native_backup/AndroidManifest.xml android/app/src/main/
          
          echo "âœ… Injection complete."

      - name: Force Bundle JS
        run: |
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file index.js \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res

      - name: Fix Gradle Wrapper (Force 8.6-bin)
        run: |
          cd android/gradle/wrapper
          sed -i 's/distributionUrl=.*$/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-8.6-bin.zip/g' gradle-wrapper.properties

      - name: Build Android APK (Debug)
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleDebug -Dorg.gradle.jvmargs="-Xmx4608m -XX:MaxMetaspaceSize=1024m" --no-daemon --stacktrace

      - name: TÃ©lÃ©charger l'APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-v1-debug
          path: android/app/build/outputs/apk/debug/app-debug.apk
