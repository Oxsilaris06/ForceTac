name: ForceTac Android Build

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4name: ForceTac Android Build (Hybrid Expo)

on: [workflow_dispatch]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Configuration de Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Configuration de Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Android NDK (Vital pour le C++)
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Installation des dÃ©pendances
        run: |
          npm cache clean --force
          npm install --legacy-peer-deps
          # Installation de expo-cli localement pour le prebuild
          npm install -g expo-cli

      # Sauvegarde de votre code natif personnalisÃ© avant que le prebuild ne touche Ã  tout
      # On sauvegarde TOUT ce qui est critique
      - name: Backup Native Code
        run: |
          mkdir -p ../native_backup
          
          # Sauvegarde du C++
          if [ -d "android/app/src/main/cpp" ]; then 
            mkdir -p ../native_backup/cpp
            cp -r android/app/src/main/cpp/* ../native_backup/cpp/
          fi
          
          # Sauvegarde du Kotlin (ForceTac package)
          if [ -d "android/app/src/main/java/com/forcetac" ]; then 
            mkdir -p ../native_backup/forcetac
            cp -r android/app/src/main/java/com/forcetac/* ../native_backup/forcetac/
          fi
          
          # Sauvegarde des Assets (ClÃ©s JSON)
          if [ -d "android/app/src/main/assets" ]; then 
            mkdir -p ../native_backup/assets
            cp -r android/app/src/main/assets/* ../native_backup/assets/
          fi
          
          # Sauvegarde de la config build.gradle (NDK config)
          if [ -f "android/app/build.gradle" ]; then cp android/app/build.gradle ../native_backup/; fi
          
          # Sauvegarde du Manifeste (Services HCE)
          if [ -f "android/app/src/main/AndroidManifest.xml" ]; then cp android/app/src/main/AndroidManifest.xml ../native_backup/; fi

      # GÃ©nÃ©ration de l'infrastructure Android via Expo
      # Cette Ã©tape crÃ©e un dossier android/ propre et fonctionnel
      - name: Expo Prebuild
        run: npx expo prebuild --platform android --clean --no-interactive

      # Restauration et Injection du code ForceTac (C++ / Kotlin) dans le projet gÃ©nÃ©rÃ©
      - name: Inject ForceTac Native Engine
        run: |
          echo "ðŸ’‰ Injecting C++ and Kotlin modules..."
          
          # 1. Restauration du moteur C++
          mkdir -p android/app/src/main/cpp
          cp -r ../native_backup/cpp/* android/app/src/main/cpp/
          
          # 2. Restauration du module Kotlin (NfcModule, HceService, Package)
          # On s'assure que le dossier package existe
          mkdir -p android/app/src/main/java/com/forcetac
          cp -r ../native_backup/forcetac/* android/app/src/main/java/com/forcetac/
          
          # 3. Restauration des Assets (ClÃ©s, IcÃ´nes)
          mkdir -p android/app/src/main/assets
          if [ -d "../native_backup/assets" ]; then
             cp -r ../native_backup/assets/* android/app/src/main/assets/ || true
          fi
          
          # 4. Restauration du build.gradle (Vital pour le NDK)
          # On Ã©crase celui gÃ©nÃ©rÃ© par Expo car il ne contient pas la config externalNativeBuild
          cp ../native_backup/build.gradle android/app/
          
          # 5. Restauration du Manifeste (Pour les permissions NFC)
          cp ../native_backup/AndroidManifest.xml android/app/src/main/
          
          echo "âœ… Injection complete."

      # GÃ©nÃ©ration du Keystore
      - name: Generate Debug Keystore
        run: |
          cd android/app
          if [ -f debug.keystore ]; then rm debug.keystore; fi
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"

      # Correction du Wrapper Gradle (Force 8.6 pour compatibilitÃ© RN 0.74)
      - name: Fix Gradle Wrapper
        run: |
          cd android/gradle/wrapper
          sed -i 's/distributionUrl=.*$/distributionUrl=https\:\/\/services.gradle.org\/distributions\/gradle-8.6-bin.zip/g' gradle-wrapper.properties

      # Build final
      - name: Build Android APK
        run: |
          cd android
          chmod +x gradlew
          ./gradlew assembleRelease --no-daemon --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-release
          path: android/app/build/outputs/apk/release/*.apk
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Setup NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r26d

      - name: Install Node Deps
        run: npm install

      # StratÃ©gie de Build : On gÃ©nÃ¨re un squelette propre et on injecte notre code
      - name: Initialize Android Environment
        run: |
          # 1. Sauvegarde de votre code source unique (C++, Kotlin, Assets)
          echo "ðŸ“¦ Backing up source code..."
          mkdir -p ../backup
          cp -r android/app/src ../backup/
          cp -r android/app/build.gradle ../backup/
          cp package.json ../backup/
          
          # 2. GÃ©nÃ©ration d'un projet RN propre dans un sous-dossier
          echo "ðŸ”§ Generating fresh React Native project..."
          # On supprime le dossier android actuel pour Ã©viter les conflits
          rm -rf android
          
          # On gÃ©nÃ¨re dans un dossier temporaire 'ForceTacTemp'
          npx react-native@0.73.4 init ForceTacTemp --skip-install --version 0.73.4
          
          # On dÃ©place le contenu du temp vers la racine (overwrite)
          cp -r ForceTacTemp/android .
          # On peut avoir besoin de certains fichiers de config racine aussi
          cp ForceTacTemp/metro.config.js . 2>/dev/null || true
          cp ForceTacTemp/babel.config.js . 2>/dev/null || true
          
          # Nettoyage
          rm -rf ForceTacTemp
          
          # 3. Restauration de VOTRE code par dessus le squelette
          echo "â™»ï¸ Restoring custom source code..."
          # On Ã©crase le src/main par le vÃ´tre
          cp -r ../backup/src/* android/app/src/
          
          # On restaure votre build.gradle spÃ©cifique (avec NDK et configs)
          cp ../backup/build.gradle android/app/
          
          # On s'assure que package.json est synchronisÃ©
          cp ../backup/package.json .
          
          # Installation des dÃ©pendances finales
          npm install

      - name: Generate Debug Keystore
        run: |
          cd android/app
          keytool -genkey -v -keystore debug.keystore -storepass android -alias androiddebugkey -keypass android -keyalg RSA -keysize 2048 -validity 10000 -dname "CN=Android Debug,O=Android,C=US"
          echo "âœ… Keystore generated."

      - name: Inject Custom Icon
        run: |
          if [ -f "assets/icon.png" ]; then
            echo "ðŸŽ¨ Injecting custom icon..."
            RES_DIR="android/app/src/main/res"
            for d in mipmap-hdpi mipmap-mdpi mipmap-xhdpi mipmap-xxhdpi mipmap-xxxhdpi; do
              mkdir -p "$RES_DIR/$d"
              cp assets/icon.png "$RES_DIR/$d/ic_launcher.png"
              cp assets/icon.png "$RES_DIR/$d/ic_launcher_round.png"
            done
          fi

      - name: Build Release APK
        run: |
          cd android
          # Configuration pour ignorer les erreurs de lint non bloquantes
          echo "android.disableAutomaticComponentCreation=true" >> gradle.properties
          
          # Lancement du build
          ./gradlew assembleRelease --stacktrace

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: forcetac-release
          path: android/app/build/outputs/apk/release/*.apk
